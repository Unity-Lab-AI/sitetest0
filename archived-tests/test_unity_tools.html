<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity Tool Calling Test</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #e0e0e0;
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        h1 {
            color: #00d4ff;
            border-bottom: 2px solid #00d4ff;
            padding-bottom: 10px;
        }
        .test-section {
            background: rgba(30, 30, 46, 0.8);
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }
        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }
        .info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #2196f3;
        }
        button {
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        .image-container {
            margin: 10px 0;
        }
        .image-container img {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Unity Tool Calling Integration Test</h1>

    <div class="test-section">
        <h2>Test Configuration</h2>
        <div id="config" class="test-result info">
            <strong>Model:</strong> Unity (using Mistral backend)<br>
            <strong>Tool Schema:</strong> Single prompt format<br>
            <strong>Endpoint:</strong> https://text.pollinations.ai/openai
        </div>
    </div>

    <div class="test-section">
        <h2>Test 1: Simple Image Generation</h2>
        <button onclick="testSimpleImage()">Run Test</button>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 2: Unity Selfie Request</h2>
        <button onclick="testUnitySelfie()">Run Test</button>
        <div id="test2-result"></div>
    </div>

    <div class="test-section">
        <h2>Test 3: Tool Call Detection</h2>
        <button onclick="testToolCallDetection()">Run Test</button>
        <div id="test3-result"></div>
    </div>

    <div class="test-section">
        <h2>Console Logs</h2>
        <pre id="console-logs">Logs will appear here...</pre>
    </div>

    <script>
        const OPENAI_ENDPOINT = 'https://text.pollinations.ai/openai';
        const REFERRER = 'UA-73J7ItT-ws';

        // Simple Unity system prompt focused on tool calling
        const UNITY_SYSTEM_PROMPT = `Assistant = Unity

Unity has access to the generate_image function tool. When users request visual content (images, pictures, photos, selfies, artwork, etc.), Unity MUST use the generate_image tool.

Unity ALWAYS uses the generate_image tool for image requests - never describes images or provides URLs manually.`;

        // Tool definition (single prompt schema)
        const TOOLS = [{
            type: 'function',
            function: {
                name: 'generate_image',
                description: 'Generates and displays an image. Use this for ANY visual content request.',
                parameters: {
                    type: 'object',
                    properties: {
                        prompt: {
                            type: 'string',
                            description: 'Detailed description of the image to generate'
                        },
                        width: {
                            type: 'integer',
                            enum: [1024, 1080, 1920],
                            default: 1024
                        },
                        height: {
                            type: 'integer',
                            enum: [1024, 1080, 1920],
                            default: 1024
                        },
                        model: {
                            type: 'string',
                            enum: ['flux', 'flux-realism', 'flux-anime', 'flux-3d', 'turbo'],
                            default: 'flux'
                        }
                    },
                    required: ['prompt']
                }
            }
        }];

        // Logger
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('console-logs');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            logsDiv.textContent += logLine;
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        // Test 1: Simple image generation
        async function testSimpleImage() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = '<div class="test-result info">Running test...</div>';
            log('Starting Test 1: Simple Image Generation');

            try {
                const payload = {
                    model: 'mistral',
                    messages: [
                        { role: 'system', content: UNITY_SYSTEM_PROMPT },
                        { role: 'user', content: 'Generate an image of a sunset over mountains' }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000,
                    tools: TOOLS,
                    tool_choice: 'auto'
                };

                log('Sending request to API...');
                log('Payload: ' + JSON.stringify(payload, null, 2));

                const response = await fetch(`${OPENAI_ENDPOINT}?referrer=${REFERRER}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                log('Received response');
                log('Response: ' + JSON.stringify(data, null, 2));

                const message = data.choices[0].message;

                if (message.tool_calls && message.tool_calls.length > 0) {
                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            ✅ SUCCESS: Tool call detected!<br>
                            Function: ${message.tool_calls[0].function.name}<br>
                            Arguments: <pre>${JSON.stringify(JSON.parse(message.tool_calls[0].function.arguments), null, 2)}</pre>
                        </div>`;
                    log('Test 1 PASSED: Tool calling working');
                } else {
                    resultDiv.innerHTML = `
                        <div class="test-result error">
                            ❌ FAILED: No tool calls detected<br>
                            Response: ${message.content || 'No content'}
                        </div>`;
                    log('Test 1 FAILED: No tool calls');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">❌ ERROR: ${error.message}</div>`;
                log('Test 1 ERROR: ' + error.message, 'error');
            }
        }

        // Test 2: Unity selfie request
        async function testUnitySelfie() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = '<div class="test-result info">Running test...</div>';
            log('Starting Test 2: Unity Selfie Request');

            try {
                const payload = {
                    model: 'mistral',
                    messages: [
                        { role: 'system', content: UNITY_SYSTEM_PROMPT },
                        { role: 'user', content: 'Unity, send me a selfie' }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000,
                    tools: TOOLS,
                    tool_choice: 'auto'
                };

                log('Sending selfie request...');

                const response = await fetch(`${OPENAI_ENDPOINT}?referrer=${REFERRER}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const data = await response.json();
                const message = data.choices[0].message;

                if (message.tool_calls && message.tool_calls.length > 0) {
                    const args = JSON.parse(message.tool_calls[0].function.arguments);
                    resultDiv.innerHTML = `
                        <div class="test-result success">
                            ✅ SUCCESS: Unity used tool calling for selfie!<br>
                            Prompt: ${args.prompt}<br>
                            Dimensions: ${args.width || 1024}x${args.height || 1024}
                        </div>`;
                    log('Test 2 PASSED: Selfie tool calling working');
                } else {
                    resultDiv.innerHTML = `
                        <div class="test-result error">
                            ❌ FAILED: Unity didn't use tool calling<br>
                            Response: ${message.content || 'No content'}
                        </div>`;
                    log('Test 2 FAILED: No tool calls for selfie');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="test-result error">❌ ERROR: ${error.message}</div>`;
                log('Test 2 ERROR: ' + error.message, 'error');
            }
        }

        // Test 3: Tool call detection
        async function testToolCallDetection() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = '<div class="test-result info">Running test...</div>';
            log('Starting Test 3: Tool Call Detection');

            const testCases = [
                'Show me a picture of a cat',
                'Generate an image of a robot',
                'Create artwork of a forest'
            ];

            let passed = 0;
            let failed = 0;

            for (const testCase of testCases) {
                try {
                    log(`Testing: "${testCase}"`);

                    const payload = {
                        model: 'mistral',
                        messages: [
                            { role: 'system', content: UNITY_SYSTEM_PROMPT },
                            { role: 'user', content: testCase }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000,
                        tools: TOOLS,
                        tool_choice: 'auto'
                    };

                    const response = await fetch(`${OPENAI_ENDPOINT}?referrer=${REFERRER}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const data = await response.json();
                    const message = data.choices[0].message;

                    if (message.tool_calls && message.tool_calls.length > 0) {
                        passed++;
                        log(`  ✅ Tool call detected for: "${testCase}"`);
                    } else {
                        failed++;
                        log(`  ❌ No tool call for: "${testCase}"`, 'error');
                    }
                } catch (error) {
                    failed++;
                    log(`  ❌ Error for "${testCase}": ${error.message}`, 'error');
                }
            }

            if (passed === testCases.length) {
                resultDiv.innerHTML = `
                    <div class="test-result success">
                        ✅ ALL TESTS PASSED (${passed}/${testCases.length})<br>
                        Unity consistently uses tool calling for image requests
                    </div>`;
            } else {
                resultDiv.innerHTML = `
                    <div class="test-result error">
                        ⚠️ PARTIAL SUCCESS (${passed}/${testCases.length} passed)<br>
                        Failed: ${failed} tests
                    </div>`;
            }

            log(`Test 3 Complete: ${passed} passed, ${failed} failed`);
        }

        log('Unity Tool Calling Test Suite Ready');
        log('Click buttons to run tests');
    </script>
</body>
</html>
