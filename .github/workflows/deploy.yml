name: Build and Deploy

# Run on push to main/master branch
on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allow manual triggering

# Grant necessary permissions
permissions:
  contents: write
  pages: write
  id-token: write
  issues: write
  pull-requests: write

# Ensure only one deployment runs at a time
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # Job 1: Minification - Minify CSS and JS assets
  minify:
    name: Minify Assets
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "üì¶ Installing minification dependencies..."
          npm install --save-dev terser clean-css-cli

      - name: Minify JavaScript
        run: |
          echo "üî® Minifying JavaScript..."
          npx terser script.js -c -m -o script.min.js
          echo "‚úÖ script.js ‚Üí script.min.js"
          ls -lh script.js script.min.js

      - name: Minify CSS
        run: |
          echo "üé® Minifying CSS..."
          npx cleancss -o styles.min.css styles.css
          echo "‚úÖ styles.css ‚Üí styles.min.css"
          ls -lh styles.css styles.min.css

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No minification changes"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚ú® Minified files updated"
          fi

      - name: Commit minified assets
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add script.min.js styles.min.css
          git commit -m "chore: minify assets for deployment [skip ci]"

          # Push with retry logic
          max_retries=4
          retry_count=0
          retry_delay=2

          while [ $retry_count -lt $max_retries ]; do
            echo "üì§ Pushing minified assets (attempt $((retry_count + 1))/$max_retries)..."
            if git push origin HEAD:${GITHUB_REF#refs/heads/}; then
              echo "‚úÖ Successfully pushed minified assets"
              exit 0
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "‚ö†Ô∏è  Push failed, retrying in ${retry_delay}s..."
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))
              fi
            fi
          done

          echo "‚ùå Failed to push after $max_retries attempts"
          exit 1

  # Job 2: Cache Busting - Updates all asset versions
  cache-busting:
    name: Update Cache Busting
    needs: minify
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: Pull latest minified assets
        run: |
          echo "üîÑ Pulling latest minified assets..."
          git pull origin ${{ github.ref_name }}
          echo "‚úÖ Working with minified assets"

      - name: Get version hash
        id: get_version
        run: |
          VERSION=$(git rev-parse --short HEAD)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Using version: $VERSION"

      - name: Update all asset versions
        env:
          VERSION: ${{ steps.get_version.outputs.version }}
        run: |
          echo "üîÑ Updating asset versions to: $VERSION"

          # List of HTML files to update
          HTML_FILES=(
            "index.html"
            "about/index.html"
            "contact/index.html"
            "projects/index.html"
            "services/index.html"
          )

          # Update each HTML file to use minified assets with cache-busting
          for file in "${HTML_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "  üìù Updating $file..."
              # Update to use minified CSS
              sed -i "s/styles\.css?v=[^\"']*/styles.min.css?v=$VERSION/g" "$file"
              sed -i "s/styles\.min\.css?v=[^\"']*/styles.min.css?v=$VERSION/g" "$file"
              # Update to use minified JS
              sed -i "s/script\.js?v=[^\"']*/script.min.js?v=$VERSION/g" "$file"
              sed -i "s/script\.min\.js?v=[^\"']*/script.min.js?v=$VERSION/g" "$file"
              # Update other JS files (keep non-minified for now)
              sed -i "s/template-loader\.js?v=[^\"']*/template-loader.js?v=$VERSION/g" "$file" || true
              sed -i "s/about\.js?v=[^\"']*/about.js?v=$VERSION/g" "$file" || true
              sed -i "s/contact\.js?v=[^\"']*/contact.js?v=$VERSION/g" "$file" || true
              sed -i "s/projects\.js?v=[^\"']*/projects.js?v=$VERSION/g" "$file" || true
              sed -i "s/services\.js?v=[^\"']*/services.js?v=$VERSION/g" "$file" || true
            else
              echo "  ‚ö†Ô∏è  Skipping $file (not found)"
            fi
          done

          echo "‚úÖ Asset versions updated successfully in all HTML files"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "‚ú® Changes detected"
          fi

      - name: Commit and push changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add index.html about/index.html contact/index.html projects/index.html services/index.html || true
          git commit -m "chore: update asset cache-busting versions to ${{ steps.get_version.outputs.version }} [skip ci]"

          # Push with retry logic for network resilience
          max_retries=4
          retry_count=0
          retry_delay=2

          while [ $retry_count -lt $max_retries ]; do
            echo "üì§ Attempting to push (attempt $((retry_count + 1))/$max_retries)..."
            if git push origin HEAD:${GITHUB_REF#refs/heads/}; then
              echo "‚úÖ Successfully pushed cache-busting updates"
              exit 0
            else
              retry_count=$((retry_count + 1))
              if [ $retry_count -lt $max_retries ]; then
                echo "‚ö†Ô∏è  Push failed, retrying in ${retry_delay}s..."
                sleep $retry_delay
                retry_delay=$((retry_delay * 2))
              fi
            fi
          done

          echo "‚ùå Failed to push after $max_retries attempts"
          exit 1

  # Job 3: Build - Validate and prepare for deployment
  build:
    name: Build and Validate
    needs: cache-busting
    runs-on: ubuntu-latest
    outputs:
      build_status: ${{ steps.build_check.outputs.status }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Pull latest cache-busting changes
        run: |
          echo "üîÑ Pulling latest changes including cache-busting updates..."
          git pull origin ${{ github.ref_name }}
          echo "‚úÖ Now working with cache-busted assets"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate HTML structure
        id: build_check
        run: |
          echo "üîç Validating HTML files..."

          # Check if required HTML files exist
          if [ ! -f "index.html" ]; then
            echo "‚ùå index.html not found!"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ ! -f "about/index.html" ]; then
            echo "‚ùå about/index.html not found!"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Validate that minified assets with cache-busting versions are present
          if ! grep -q "styles.min.css?v=" index.html; then
            echo "‚ùå Minified CSS with cache-busting version missing in index.html"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          if ! grep -q "script.min.js?v=" index.html; then
            echo "‚ùå Minified JS with cache-busting version missing in index.html"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check for broken internal links (basic check)
          echo "üîó Checking for minified asset files..."
          if [ ! -f "styles.min.css" ] || [ ! -f "script.min.js" ]; then
            echo "‚ùå Required minified assets missing!"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "‚úÖ Build validation passed"
          echo "status=success" >> $GITHUB_OUTPUT

      - name: Upload artifact for deployment
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'

  # Job 4a: Report Build Status
  report-status:
    name: Report Build Status
    needs: build
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Report success
        if: needs.build.outputs.build_status == 'success'
        run: |
          echo "‚úÖ BUILD SUCCESSFUL"
          echo "================================"
          echo "Version: ${{ needs.cache-busting.outputs.version }}"
          echo "Status: SUCCESS"
          echo "Ready for deployment"
          echo "================================"

      - name: Report failure
        if: needs.build.outputs.build_status == 'failed'
        run: |
          echo "‚ùå BUILD FAILED"
          echo "================================"
          echo "Version: ${{ needs.cache-busting.outputs.version }}"
          echo "Status: FAILED"
          echo "Check build logs for details"
          echo "================================"
          exit 1

      - name: Create status comment (if PR)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.build.outputs.build_status }}';
            const version = '${{ needs.cache-busting.outputs.version }}';
            const icon = status === 'success' ? '‚úÖ' : '‚ùå';
            const message = status === 'success' ? 'Build successful!' : 'Build failed!';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **${message}**\n\n**Version:** \`${version}\`\n**Status:** ${status.toUpperCase()}`
            });

  # Job 4b: Deploy to GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.build_status == 'success'

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Report deployment success
        run: |
          echo "üöÄ DEPLOYMENT SUCCESSFUL"
          echo "================================"
          echo "URL: ${{ steps.deployment.outputs.page_url }}"
          echo "Version: ${{ needs.cache-busting.outputs.version }}"
          echo "================================"
          echo ""
          echo "‚ú® Your site is now live with the latest updates!"
          echo "üîÑ Dynamic content (like GitHub stats) will update automatically"

  # Job 4c: Run Playwright Tests
  playwright-tests:
    name: Run Playwright Tests
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.outputs.build_status == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref_name }}
          fetch-depth: 0

      - name: Pull latest cache-busting changes
        run: |
          echo "üîÑ Pulling latest changes including cache-busting updates..."
          git pull origin ${{ github.ref_name }}
          echo "‚úÖ Now working with cache-busted assets"

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "üì¶ Installing Playwright dependencies..."
          npm install

      - name: Install Playwright browsers
        run: |
          echo "üåê Installing Playwright browsers..."
          npx playwright install --with-deps chromium

      - name: Start local server
        run: |
          echo "üöÄ Starting local server..."
          python3 -m http.server 8080 &
          sleep 3
          echo "‚úÖ Server started on port 8080"

      - name: Run Playwright tests
        run: |
          echo "üß™ Running Playwright tests..."
          npx playwright test
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test results JSON
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: test-results/
          retention-days: 30

      - name: Report test success
        if: success()
        run: |
          echo "‚úÖ PLAYWRIGHT TESTS PASSED"
          echo "================================"
          echo "All tests completed successfully"
          echo "================================"

      - name: Report test failure
        if: failure()
        run: |
          echo "‚ùå PLAYWRIGHT TESTS FAILED"
          echo "================================"
          echo "Check test results for details"
          echo "================================"
          exit 1
